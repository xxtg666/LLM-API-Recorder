<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ web_title }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e1e5e9;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c5aa0;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-input {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d9e0;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 250px;
        }

        .search-btn {
            padding: 0.5rem 1rem;
            background: #2c5aa0;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .search-btn:hover {
            background: #1e3f73;
        }
        
        .advanced-search-toggle {
            background: none;
            border: 1px solid #d1d9e0;
            color: #4a5568;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .advanced-search-toggle:hover {
            background: #f8fafc;
            border-color: #2c5aa0;
            color: #2c5aa0;
        }
        
        .advanced-search-toggle.active {
            background: #e0e7ff;
            border-color: #2c5aa0;
            color: #2c5aa0;
        }
        
        .advanced-search-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .advanced-search-panel.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        
        .advanced-search-content {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            width: 100%;
            max-width: 900px;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .advanced-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .advanced-search-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 1.25rem;
        }
        
        .close-advanced-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            line-height: 1;
        }
        
        .close-advanced-btn:hover {
            color: #1f2937;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-group label {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .filter-group input, .filter-group select {
            padding: 0.4rem 0.6rem;
            border: 1px solid #d1d9e0;
            border-radius: 4px;
            font-size: 0.85rem;
            min-width: 120px;
        }
        
        .filter-group input[type="number"] {
            width: 100px;
        }
        
        .filter-group input[type="date"] {
            width: 140px;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e1e5e9;
        }
        
        .quick-filter-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid #d1d9e0;
            background: white;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            color: #4a5568;
        }
        
        .quick-filter-btn:hover {
            background: #f8fafc;
            border-color: #2c5aa0;
        }
        
        .quick-filter-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }
        
        .filter-summary {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .filter-summary .clear-btn {
            background: none;
            border: none;
            color: #1e40af;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.85rem;
        }
        
        .match-snippet {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        
        .match-snippet .source-tag {
            display: inline-block;
            background: #fde047;
            color: #713f12;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-right: 0.5rem;
        }
        
        .match-snippet .snippet-text {
            color: #374151;
        }
        
        .match-snippet .highlight {
            background: #fde047;
            font-weight: 600;
        }
        
        .match-snippets {
            margin-top: 0.5rem;
        }
        
        .request-row .match-snippet {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
            margin-top: 0.3rem;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .request-row .match-snippet:hover {
            white-space: normal;
            overflow: visible;
        }
        
        /* é«˜äº®æ ·å¼ */
        .highlight {
            background: #fde047 !important;
            color: #713f12 !important;
            padding: 0 2px;
            border-radius: 2px;
        }

        .main-content {
            padding: 2rem 0;
        }

        .stats-bar {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c5aa0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .requests-table {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            font-weight: 600;
            color: #2c5aa0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #f0f4f8;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-success {
            background: #e6fffa;
            color: #065f46;
        }

        .status-error {
            background: #fef2f2;
            color: #991b1b;
        }

        .status-pending {
            background: #fffbeb;
            color: #92400e;
        }

        .request-id {
            font-weight: 600;
            color: #2c5aa0;
            font-size: 0.9rem;
        }
        
        .model-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .app-tag {
            background: #ecfdf5;
            color: #059669;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .token-info {
            display: flex;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .token-item {
            background: #f3f4f6;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            color: #374151;
        }

        .duration {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .content-preview {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .pagination {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d9e0;
            background: #fff;
            color: #374151;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .page-btn:hover {
            background: #f3f4f6;
        }

        .page-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-cell {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .loading-dots {
            display: inline-flex;
            gap: 0.15rem;
            margin-left: 0.25rem;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: #2c5aa0;
            border-radius: 50%;
            animation: blink 1s infinite ease-in-out;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0.2; }
            40% { opacity: 1; }
        }

        .load-progress {
            display: none;
            gap: 0.75rem;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            background: #f8fafc;
        }

        .load-progress .progress-text {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            font-size: 0.9rem;
            color: #374151;
            min-width: 180px;
        }

        .progress-track {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #60a5fa, #2563eb);
            border-radius: 999px;
            transition: width 0.15s ease-out;
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .request-row {
            cursor: pointer;
        }

        .request-row:hover {
            background: #f8fafc !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .search-input {
                width: 200px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            table {
                font-size: 0.8rem;
            }
            
            th, td {
                padding: 0.5rem;
            }
        }
        
        /* finish_reason å¾½ç« æ ·å¼ */
        .finish-reason-badge {
            background: #f3f4f6;
            color: #374151;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        
        .finish-reason-badge.stop, .finish-reason-badge.end_turn {
            background: #dcfce7;
            color: #166534;
        }
        
        .finish-reason-badge.length {
            background: #fef3c7;
            color: #92400e;
        }
        
        .finish-reason-badge.tool_calls, .finish-reason-badge.function_call {
            background: #fef3c7;
            color: #d97706;
        }
        
        .finish-reason-badge.content_filter {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* æ¡ä»¶æ„å»ºå™¨æ ·å¼ */
        .condition-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .condition-item select, .condition-item input {
            padding: 0.4rem 0.6rem;
            border: 1px solid #d1d9e0;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .condition-item .field-select {
            min-width: 150px;
        }
        
        .condition-item .operator-select {
            min-width: 100px;
        }
        
        .condition-item .value-input {
            min-width: 150px;
            flex: 1;
        }
        
        .condition-item .role-select {
            min-width: 100px;
        }
        
        .condition-item .remove-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .condition-item .remove-btn:hover {
            background: #fecaca;
        }
        
        .condition-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 0.25rem;
        }
        
        .condition-tag .remove-tag {
            background: none;
            border: none;
            color: #6366f1;
            cursor: pointer;
            padding: 0 0.2rem;
            font-size: 1rem;
            line-height: 1;
        }
        
        .condition-tag .remove-tag:hover {
            color: #dc2626;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">{{ web_title }}</div>
                <form class="search-box" method="post" action="/search" id="searchForm">
                    <input type="hidden" name="page" value="1">
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" name="search" class="search-input" placeholder="æœç´¢ (ç©ºæ ¼åˆ†éš”å¤šè¯, -æ’é™¤)" value="{{ search }}" id="searchInput" title="æ”¯æŒå¤šå…³é”®è¯æœç´¢ï¼šç©ºæ ¼åˆ†éš”å¤šä¸ªè¯ï¼Œ-å·å¼€å¤´æ’é™¤è¯¥è¯ï¼Œå¼•å·åŒ…è£¹ç²¾ç¡®çŸ­è¯­">
                        
                        <select name="search_field" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: white; font-size: 0.85rem;" title="é»˜è®¤æœå“åº”ï¼Œå…¨éƒ¨å†…å®¹è‡ªåŠ¨é™åˆ¶15å¤©">
                            <option value="response" {% if search_field == 'response' or not search_field %}selected{% endif %}>å“åº”å†…å®¹</option>
                            <option value="request" {% if search_field == 'request' %}selected{% endif %}>è¯·æ±‚å†…å®¹</option>
                            <option value="content" {% if search_field == 'content' %}selected{% endif %}>å…¨éƒ¨å†…å®¹(è¿‘15å¤©)</option>
                            <option value="error" {% if search_field == 'error' %}selected{% endif %}>é”™è¯¯ä¿¡æ¯</option>
                        </select>
                        
                        <button type="submit" class="search-btn">æœç´¢</button>
                        <button type="button" class="advanced-search-toggle" onclick="toggleAdvancedSearch()" id="advancedToggle">
                            <span>é«˜çº§ç­›é€‰</span>
                            <span id="advancedArrow">â–¼</span>
                        </button>
                        <button type="button" class="search-btn" style="background: #6b7280;" onclick="clearAllFilters()">æ¸…é™¤</button>
                    </div>
                </form>
            </div>
            
        </div>
    </header>
    
    <!-- é«˜çº§æœç´¢é¢æ¿ï¼ˆå…¨å±æ¨¡æ€æ¡†ï¼‰ -->
    <div class="advanced-search-panel" id="advancedSearchPanel">
        <div class="advanced-search-content">
            <div class="advanced-search-header">
                <h3>ğŸ” é«˜çº§æœç´¢</h3>
                <button type="button" class="close-advanced-btn" onclick="toggleAdvancedSearch()">&times;</button>
            </div>
            
            <div class="filter-row">
                    <div class="filter-group">
                        <label>æ¨¡å‹</label>
                        <select name="model_filter" form="searchForm">
                            <option value="">æ‰€æœ‰æ¨¡å‹</option>
                            {% for model in all_models %}
                            <option value="{{ model }}" {% if model_filter == model %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>åº”ç”¨</label>
                        <select name="app_filter" form="searchForm">
                            <option value="">æ‰€æœ‰åº”ç”¨</option>
                            {% for app in all_apps %}
                            <option value="{{ app }}" {% if app_filter == app %}selected{% endif %}>{{ app }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>çŠ¶æ€</label>
                        <select name="status_filter" form="searchForm">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="success" {% if status_filter == 'success' %}selected{% endif %}>âœ… æˆåŠŸ</option>
                            <option value="error" {% if status_filter == 'error' %}selected{% endif %}>âŒ å¤±è´¥</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>â³ å¤„ç†ä¸­</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>æ’åºæ–¹å¼</label>
                        <select name="sort_by" form="searchForm">
                            <option value="time" {% if sort_by == 'time' or not sort_by %}selected{% endif %}>â° æ—¶é—´</option>
                            <option value="tokens" {% if sort_by == 'tokens' %}selected{% endif %}>ğŸ”¢ Tokenæ•°</option>
                            <option value="duration" {% if sort_by == 'duration' %}selected{% endif %}>â±ï¸ è€—æ—¶</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>æ’åºæ–¹å‘</label>
                        <select name="sort_order" form="searchForm">
                            <option value="desc" {% if sort_order == 'desc' or not sort_order %}selected{% endif %}>â†“ é™åº</option>
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>â†‘ å‡åº</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label>å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" name="date_from" form="searchForm" value="{{ date_from }}">
                    </div>
                    
                    <div class="filter-group">
                        <label>ç»“æŸæ—¥æœŸ</label>
                        <input type="date" name="date_to" form="searchForm" value="{{ date_to }}">
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                        <button type="button" class="quick-filter-btn" onclick="setDateRange('today')">ä»Šå¤©</button>
                        <button type="button" class="quick-filter-btn" onclick="setDateRange('week')">æœ€è¿‘7å¤©</button>
                        <button type="button" class="quick-filter-btn" onclick="setDateRange('month')">æœ€è¿‘30å¤©</button>
                    </div>
                    
                    <div class="filter-group">
                        <label>èµ·å§‹ID</label>
                        <input type="number" name="id_from" form="searchForm" placeholder="ä»" value="{{ id_from }}" min="1">
                    </div>
                    
                    <div class="filter-group">
                        <label>ç»“æŸID</label>
                        <input type="number" name="id_to" form="searchForm" placeholder="åˆ°" value="{{ id_to }}" min="1">
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label>æœ€å°Token</label>
                        <input type="number" name="min_tokens" form="searchForm" placeholder="0" value="{{ min_tokens }}" min="0">
                    </div>
                    
                    <div class="filter-group">
                        <label>æœ€å¤§Token</label>
                        <input type="number" name="max_tokens" form="searchForm" placeholder="ä¸é™" value="{{ max_tokens }}" min="0">
                    </div>
                    
                    <div class="filter-group">
                        <label>æœ€å°è€—æ—¶(ç§’)</label>
                        <input type="number" name="min_duration" form="searchForm" placeholder="0" value="{{ min_duration }}" min="0" step="0.1">
                    </div>
                    
                    <div class="filter-group">
                        <label>æœ€å¤§è€—æ—¶(ç§’)</label>
                        <input type="number" name="max_duration" form="searchForm" placeholder="ä¸é™" value="{{ max_duration }}" min="0" step="0.1">
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" form="searchForm" class="search-btn">åº”ç”¨ç­›é€‰</button>
                    <button type="button" class="search-btn" style="background: #6b7280;" onclick="clearAdvancedFilters()">æ¸…é™¤é«˜çº§ç­›é€‰</button>
                </div>
                
                <!-- é«˜çº§æ¡ä»¶æ„å»ºå™¨ -->
                <div style="margin-top: 1rem; padding: 1rem; background: #fff; border: 1px solid #e1e5e9; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h5 style="margin: 0; color: #374151;">ğŸ” é«˜çº§æ¡ä»¶æ„å»ºå™¨ (é»˜è®¤è¿‘15å¤©é™åˆ¶)</h5>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="quick-filter-btn" onclick="copyConditions()" title="å¤åˆ¶å½“å‰æ¡ä»¶">ğŸ“‹ å¤åˆ¶</button>
                            <button type="button" class="quick-filter-btn" onclick="pasteConditions()" title="ç²˜è´´æ¡ä»¶">ğŸ“¥ ç²˜è´´</button>
                            <button type="button" class="quick-filter-btn" style="background: #2c5aa0; color: white;" onclick="addCondition()">+ æ·»åŠ æ¡ä»¶</button>
                        </div>
                    </div>
                    
                    <div id="conditionsContainer">
                        <!-- æ¡ä»¶é¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                    
                    <input type="hidden" name="cond" id="conditionsInput" form="searchForm">
                </div>
                
                <!-- æœç´¢è¯­æ³•è¯´æ˜ -->
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px; font-size: 0.8rem; color: #6b7280;">
                    <strong>æœç´¢è¯­æ³•ï¼š</strong>
                    <span style="margin-left: 0.5rem;">å¤šè¯æœç´¢ç”¨ç©ºæ ¼åˆ†éš”</span> |
                    <span><code>-è¯</code> æ’é™¤åŒ…å«è¯¥è¯çš„ç»“æœ</span> |
                    <span><code>"ç²¾ç¡®çŸ­è¯­"</code> ç²¾ç¡®åŒ¹é…çŸ­è¯­</span>
                </div>
        </div>
    </div>

    <main class="main-content">
        <div class="container">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-bar">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="stat-total-requests">{{ stats.total_requests }}</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-input-tokens">{{ stats.total_input_tokens }}</div>
                        <div class="stat-label">è¾“å…¥Token</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-output-tokens">{{ stats.total_output_tokens }}</div>
                        <div class="stat-label">è¾“å‡ºToken</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-total-tokens">{{ stats.total_tokens }}</div>
                        <div class="stat-label">æ€»Tokenæ¶ˆè€—</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-avg-duration">{{ "%.3f"|format(stats.avg_duration) }}s</div>
                        <div class="stat-label">å¹³å‡å¤„ç†æ—¶é—´</div>
                    </div>
                </div>
            </div>

            <!-- è¯·æ±‚è®°å½•è¡¨æ ¼ -->
            <div class="requests-table">
                <div class="table-header">
                    {% if filter_summary %}
                    <span id="filter-summary-text">ç­›é€‰ç»“æœ (<span id="header-total">{{ result.total }}</span> æ¡è®°å½•)</span>
                    {% else %}
                    è¯·æ±‚è®°å½• (<span id="header-total">{{ result.total }}</span> æ¡è®°å½•)
                    {% endif %}
                </div>
                
                {% if filter_summary %}
                <div class="filter-summary" id="filterSummaryBar">
                    <span>{{ filter_summary }}</span>
                    <button class="clear-btn" onclick="clearAllFilters()">æ¸…é™¤å…¨éƒ¨ç­›é€‰</button>
                </div>
                {% endif %}
                <div class="load-progress" id="load-progress">
                    <div class="progress-text">
                        <span id="progress-label">æ­£åœ¨åŠ è½½åˆ—è¡¨</span>
                        <span id="progress-time" style="color: #6b7280; font-size: 0.8rem;">é¢„ä¼°ä¸­...</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-bar" id="load-progress-bar"></div>
                    </div>
                </div>
                
                <div id="requests-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>æ—¶é—´</th>
                                <th>æ¨¡å‹</th>
                                <th>åº”ç”¨</th>
                                <th>çŠ¶æ€</th>
                                <th>Tokenä½¿ç”¨</th>
                                <th>è€—æ—¶</th>
                            </tr>
                        </thead>
                        <tbody id="requests-tbody">
                            {% if not skip_list and result.requests %}
                                {% for req in result.requests %}
                                <tr class="request-row" onclick="showRequestDetail({{ req.id }})">
                                    <td><span class="request-id">#{{ req.id }}</span></td>
                                    <td><small style="color: #6b7280;">{{ req.timestamp.split('T')[0] }}</small><br>{{ req.timestamp.split('T')[1].split('.')[0] }}</td>
                                    <td><span class="model-tag">{{ req.model }}</span></td>
                                    <td>{% if req.app_name %}<span class="app-tag">{{ req.app_name }}</span>{% else %}<span style="color: #9ca3af; font-style: italic;">-</span>{% endif %}</td>
                                    <td>{% if req.status_code == 200 %}<span class="status-badge status-success">æˆåŠŸ</span>{% elif req.status_code == 0 %}<span class="status-badge status-pending">å¤„ç†ä¸­</span>{% else %}<span class="status-badge status-error">é”™è¯¯</span>{% endif %}</td>
                                    <td><div class="token-info"><span class="token-item">è¾“å…¥: {{ req.formatted_input_tokens }}</span><span class="token-item">è¾“å‡º: {{ req.formatted_output_tokens }}</span><span class="token-item">æ€»è®¡: {{ req.formatted_total_tokens }}</span></div></td>
                                    <td><span class="duration">{{ req.formatted_duration }}</span></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr><td class="loading-cell" colspan="7">æ­£åœ¨åŠ è½½è¯·æ±‚åˆ—è¡¨<div class="loading-dots"><span></span><span></span><span></span></div></td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <div class="pagination" id="pagination-container">
                        {% if not skip_list and result.pages > 1 %}
                            {% if current_page > 1 %}
                            <a href="?page={{ current_page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if model_filter %}&model_filter={{ model_filter }}{% endif %}{% if app_filter %}&app_filter={{ app_filter }}{% endif %}" class="page-btn">ä¸Šä¸€é¡µ</a>
                            {% endif %}
                            {% for page_num in range(1, result.pages + 1) %}
                                {% if page_num == current_page %}
                                <span class="page-btn active">{{ page_num }}</span>
                                {% elif page_num <= 3 or page_num > result.pages - 3 or (page_num >= current_page - 2 and page_num <= current_page + 2) %}
                                <a href="?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}{% if model_filter %}&model_filter={{ model_filter }}{% endif %}{% if app_filter %}&app_filter={{ app_filter }}{% endif %}" class="page-btn">{{ page_num }}</a>
                                {% elif page_num == 4 or page_num == result.pages - 3 %}
                                <span class="page-btn">...</span>
                                {% endif %}
                            {% endfor %}
                            {% if current_page < result.pages %}
                            <a href="?page={{ current_page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if model_filter %}&model_filter={{ model_filter }}{% endif %}{% if app_filter %}&app_filter={{ app_filter }}{% endif %}" class="page-btn">ä¸‹ä¸€é¡µ</a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- è¯·æ±‚è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="requestModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; width: 95%; max-width: 1200px; max-height: 90%; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 1.5rem; border-bottom: 1px solid #e1e5e9; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h3>è¯·æ±‚è¯¦æƒ…</h3>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="copyLinkBtn" onclick="copyRequestLink()" style="background: #e0e7ff; color: #3730a3; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
                        ğŸ“‹ å¤åˆ¶é“¾æ¥
                    </button>
                    <button onclick="closeRequestDetail()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
            </div>
            <div id="requestDetailContent" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                åŠ è½½ä¸­...
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/json-viewer-js@1.3.0/dist/json-viewer.min.js"></script>
    <style>
        /* è¯·æ±‚è¯¦æƒ…æ ·å¼ */
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .detail-title {
            color: #2c5aa0;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }
        
        .view-toggle {
            background: #e0e7ff;
            color: #3730a3;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .view-toggle:hover {
            background: #c7d2fe;
        }
        
        .view-toggle.active {
            background: #3730a3;
            color: white;
        }
        
        .content-wrapper {
            background: #f8fafc;
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid #e1e5e9;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .message-item {
            background: white;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message-item.user {
            border-left-color: #3b82f6;
        }
        
        .message-item.assistant {
            border-left-color: #10b981;
        }
        
        .message-item.system {
            border-left-color: #f59e0b;
        }
        
        .message-role {
            font-weight: 600;
            text-transform: capitalize;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .message-role:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .message-role::after {
            content: 'â–¼';
            font-size: 0.8rem;
            transition: transform 0.2s;
        }
        
        .message-role.collapsed::after {
            transform: rotate(-90deg);
        }
        
        .message-role.user {
            color: #3b82f6;
        }
        
        .message-role.assistant {
            color: #10b981;
        }
        
        .message-role.system {
            color: #f59e0b;
        }
        
        .message-content {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: anywhere;
        }
        
        .param-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .param-grid.basic-info {
            grid-template-rows: repeat(2, 1fr);
        }
        
        .param-item {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .param-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .param-value {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .param-value.boolean {
            color: #059669;
        }
        
        .param-value.number {
            color: #dc2626;
        }
        
        .raw-json {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: anywhere;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .usage-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .usage-item {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .usage-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3730a3;
            display: block;
        }
        
        .usage-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* å·¥å…·è°ƒç”¨ç›¸å…³æ ·å¼ */
        .tools-section {
            margin-top: 1rem;
        }
        
        .tool-item {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #8b5cf6;
        }
        
        .tool-name {
            font-weight: 600;
            color: #7c3aed;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tool-description {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        .tool-params {
            background: #f8fafc;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: #374151;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: anywhere;
        }
        
        .tool-call-item {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #f59e0b;
        }
        
        .tool-call-name {
            font-weight: 600;
            color: #d97706;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tool-call-id {
            font-size: 0.75rem;
            color: #9ca3af;
            font-family: 'Courier New', monospace;
        }
        
        .tool-result-item {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #10b981;
        }
        
        .tool-result-name {
            font-weight: 600;
            color: #059669;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }
        
        .collapsible-header:hover {
            background-color: rgba(0,0,0,0.03);
            border-radius: 4px;
        }
        
        .collapsible-header::before {
            content: 'â–¼';
            font-size: 0.7rem;
            transition: transform 0.2s;
            color: #9ca3af;
        }
        
        .collapsible-header.collapsed::before {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            margin-top: 0.5rem;
        }
        
        .collapsible-content.hidden {
            display: none;
        }
        
        /* åŸå§‹JSONå¤åˆ¶æŒ‰é’®æ ·å¼ */
        .raw-json-wrapper {
            position: relative;
        }
        
        .copy-json-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #4b5563;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: background-color 0.2s;
            z-index: 10;
        }
        
        .copy-json-btn:hover {
            background: #374151;
        }
        
        .copy-json-btn.copied {
            background: #059669;
        }
        
        .badge-count {
            background: #e0e7ff;
            color: #3730a3;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
    </style>

    <script>
        // é«˜çº§æ¡ä»¶æ•°ç»„
        let advancedConditions = [];
        let conditionIdCounter = 0;
        
        // æ¡ä»¶å­—æ®µé…ç½®
        const conditionFields = {
            'role': {
                label: 'æ¶ˆæ¯è§’è‰²',
                operators: [
                    { value: 'exists', label: 'åŒ…å«' },
                    { value: 'not_exists', label: 'ä¸åŒ…å«' }
                ],
                values: [
                    { value: 'system', label: 'ç³»ç»Ÿæ¶ˆæ¯ (system)' },
                    { value: 'user', label: 'ç”¨æˆ·æ¶ˆæ¯ (user)' },
                    { value: 'assistant', label: 'åŠ©æ‰‹æ¶ˆæ¯ (assistant)' },
                    { value: 'tool', label: 'å·¥å…·æ¶ˆæ¯ (tool)' }
                ],
                needsValue: true,
                isSelect: true
            },
            'role_content': {
                label: 'è§’è‰²å†…å®¹',
                operators: [
                    { value: 'contains', label: 'åŒ…å«' },
                    { value: 'not_contains', label: 'ä¸åŒ…å«' }
                ],
                roles: [
                    { value: 'system', label: 'ç³»ç»Ÿ' },
                    { value: 'user', label: 'ç”¨æˆ·' },
                    { value: 'assistant', label: 'åŠ©æ‰‹' }
                ],
                needsValue: true,
                needsRole: true,
                placeholder: 'è¾“å…¥è¦æœç´¢çš„å†…å®¹'
            },
            'any_content': {
                label: 'ä»»æ„å†…å®¹',
                operators: [
                    { value: 'contains', label: 'åŒ…å«' },
                    { value: 'not_contains', label: 'ä¸åŒ…å«' }
                ],
                needsValue: true,
                placeholder: 'è¾“å…¥è¦æœç´¢çš„å†…å®¹'
            },
            'has_feature': {
                label: 'è¯·æ±‚ç‰¹å¾',
                operators: [
                    { value: 'has', label: 'æœ‰' },
                    { value: 'not_has', label: 'æ— ' }
                ],
                values: [
                    { value: 'system_prompt', label: 'ç³»ç»Ÿæç¤ºè¯' },
                    { value: 'tools', label: 'å·¥å…·å®šä¹‰' },
                    { value: 'tool_calls', label: 'å·¥å…·è°ƒç”¨' },
                    { value: 'images', label: 'å›¾ç‰‡' },
                    { value: 'functions', label: 'å‡½æ•°å®šä¹‰' },
                    { value: 'stream', label: 'æµå¼è¯·æ±‚' },
                    { value: 'error', label: 'é”™è¯¯' }
                ],
                needsValue: true,
                isSelect: true
            },
            'model_contains': {
                label: 'æ¨¡å‹å',
                operators: [
                    { value: 'contains', label: 'åŒ…å«' },
                    { value: 'not_contains', label: 'ä¸åŒ…å«' }
                ],
                needsValue: true,
                placeholder: 'è¾“å…¥æ¨¡å‹åå…³é”®è¯'
            },
            'app_contains': {
                label: 'åº”ç”¨å',
                operators: [
                    { value: 'contains', label: 'åŒ…å«' },
                    { value: 'not_contains', label: 'ä¸åŒ…å«' }
                ],
                needsValue: true,
                placeholder: 'è¾“å…¥åº”ç”¨åå…³é”®è¯'
            },
            'error_contains': {
                label: 'é”™è¯¯ä¿¡æ¯',
                operators: [
                    { value: 'contains', label: 'åŒ…å«' },
                    { value: 'not_contains', label: 'ä¸åŒ…å«' }
                ],
                needsValue: true,
                placeholder: 'è¾“å…¥é”™è¯¯ä¿¡æ¯å…³é”®è¯'
            },
            'param': {
                label: 'è¯·æ±‚å‚æ•°',
                operators: [
                    { value: 'exists', label: 'å­˜åœ¨' },
                    { value: 'not_exists', label: 'ä¸å­˜åœ¨' },
                    { value: 'eq', label: 'ç­‰äº' }
                ],
                params: [
                    { value: 'temperature', label: 'temperature' },
                    { value: 'max_tokens', label: 'max_tokens' },
                    { value: 'top_p', label: 'top_p' },
                    { value: 'presence_penalty', label: 'presence_penalty' },
                    { value: 'frequency_penalty', label: 'frequency_penalty' }
                ],
                needsParam: true,
                needsValue: false // åªæœ‰ eq æ“ä½œç¬¦éœ€è¦å€¼
            }
        };
        
        function addCondition(preset = null) {
            const id = conditionIdCounter++;
            const container = document.getElementById('conditionsContainer');
            
            const conditionHtml = `
                <div class="condition-item" id="condition-${id}">
                    <select class="field-select" onchange="updateConditionFields(${id})" id="field-${id}">
                        <option value="">é€‰æ‹©æ¡ä»¶ç±»å‹</option>
                        ${Object.entries(conditionFields).map(([key, config]) => 
                            `<option value="${key}">${config.label}</option>`
                        ).join('')}
                    </select>
                    <div id="condition-controls-${id}" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;"></div>
                    <button type="button" class="remove-btn" onclick="removeCondition(${id})">âœ•</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', conditionHtml);
            
            if (preset) {
                applyPreset(id, preset);
            }
        }
        
        function updateConditionFields(id) {
            const fieldSelect = document.getElementById(`field-${id}`);
            const controlsContainer = document.getElementById(`condition-controls-${id}`);
            const fieldType = fieldSelect.value;
            
            if (!fieldType || !conditionFields[fieldType]) {
                controlsContainer.innerHTML = '';
                return;
            }
            
            const config = conditionFields[fieldType];
            let html = '';
            
            // æ“ä½œç¬¦é€‰æ‹©
            html += `<select class="operator-select" id="operator-${id}">`;
            config.operators.forEach(op => {
                html += `<option value="${op.value}">${op.label}</option>`;
            });
            html += '</select>';
            
            // å¦‚æœéœ€è¦è§’è‰²é€‰æ‹© (role_content)
            if (config.needsRole) {
                html += `<select class="role-select" id="role-${id}">`;
                config.roles.forEach(role => {
                    html += `<option value="${role.value}">${role.label}</option>`;
                });
                html += '</select>';
                html += '<span style="color: #6b7280; font-size: 0.8rem;">çš„æ¶ˆæ¯</span>';
            }
            
            // å¦‚æœéœ€è¦å‚æ•°åé€‰æ‹© (param)
            if (config.needsParam) {
                html += `<select class="param-select" id="param-${id}">`;
                config.params.forEach(param => {
                    html += `<option value="${param.value}">${param.label}</option>`;
                });
                html += '</select>';
            }
            
            // å€¼è¾“å…¥
            if (config.needsValue) {
                if (config.isSelect && config.values) {
                    html += `<select class="value-input" id="value-${id}">`;
                    config.values.forEach(val => {
                        html += `<option value="${val.value}">${val.label}</option>`;
                    });
                    html += '</select>';
                } else {
                    html += `<input type="text" class="value-input" id="value-${id}" placeholder="${config.placeholder || 'è¾“å…¥å€¼'}">`;
                }
            }
            
            controlsContainer.innerHTML = html;
        }
        
        function removeCondition(id) {
            const element = document.getElementById(`condition-${id}`);
            if (element) {
                element.remove();
            }
        }
        
        // å¤åˆ¶æ¡ä»¶åˆ°å‰ªè´´æ¿
        function copyConditions() {
            const conditions = collectConditions();
            if (conditions.length === 0) {
                alert('æ²¡æœ‰æ¡ä»¶å¯å¤åˆ¶');
                return;
            }
            const encoded = btoa(encodeURIComponent(JSON.stringify(conditions)));
            navigator.clipboard.writeText(encoded).then(() => {
                alert('æ¡ä»¶å·²å¤åˆ¶ï¼å¯åœ¨å…¶ä»–é¡µé¢ç²˜è´´ä½¿ç”¨');
            }).catch(() => {
                prompt('å¤åˆ¶ä»¥ä¸‹å†…å®¹:', encoded);
            });
        }
        
        // ä»å‰ªè´´æ¿ç²˜è´´æ¡ä»¶
        function pasteConditions() {
            navigator.clipboard.readText().then(text => {
                applyConditionsFromText(text);
            }).catch(() => {
                const text = prompt('è¯·ç²˜è´´æ¡ä»¶å†…å®¹:');
                if (text) applyConditionsFromText(text);
            });
        }
        
        function applyConditionsFromText(text) {
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(text.trim())));
                if (Array.isArray(decoded)) {
                    document.getElementById('conditionsContainer').innerHTML = '';
                    conditionIdCounter = 0;
                    decoded.forEach(cond => restoreCondition(cond));
                } else {
                    alert('æ— æ•ˆçš„æ¡ä»¶æ ¼å¼');
                }
            } catch (e) {
                try {
                    const decoded = JSON.parse(text.trim());
                    if (Array.isArray(decoded)) {
                        document.getElementById('conditionsContainer').innerHTML = '';
                        conditionIdCounter = 0;
                        decoded.forEach(cond => restoreCondition(cond));
                    } else {
                        alert('æ— æ•ˆçš„æ¡ä»¶æ ¼å¼');
                    }
                } catch (e2) {
                    alert('æ— æ³•è§£ææ¡ä»¶å†…å®¹');
                }
            }
        }
        
        // æ¢å¤å•ä¸ªæ¡ä»¶
        function restoreCondition(cond) {
            const id = conditionIdCounter++;
            const container = document.getElementById('conditionsContainer');
            
            const conditionHtml = `
                <div class="condition-item" id="condition-${id}">
                    <select class="field-select" onchange="updateConditionFields(${id})" id="field-${id}">
                        <option value="">é€‰æ‹©æ¡ä»¶ç±»å‹</option>
                        ${Object.entries(conditionFields).map(([key, config]) => 
                            `<option value="${key}">${config.label}</option>`
                        ).join('')}
                    </select>
                    <div id="condition-controls-${id}" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;"></div>
                    <button type="button" class="remove-btn" onclick="removeCondition(${id})">âœ•</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', conditionHtml);
            
            const fieldSelect = document.getElementById(`field-${id}`);
            fieldSelect.value = cond.field;
            updateConditionFields(id);
            
            setTimeout(() => {
                const operatorSelect = document.getElementById(`operator-${id}`);
                const valueInput = document.getElementById(`value-${id}`);
                const roleSelect = document.getElementById(`role-${id}`);
                const paramSelect = document.getElementById(`param-${id}`);
                
                if (operatorSelect) {
                    operatorSelect.value = cond.field === 'has_feature' 
                        ? (cond.negate ? 'not_has' : 'has') 
                        : (cond.operator || '');
                }
                if (valueInput) valueInput.value = cond.value || '';
                if (roleSelect) roleSelect.value = cond.role || '';
                if (paramSelect) paramSelect.value = cond.param_name || '';
            }, 10);
        }
        
        // ä»sessionStorageæ¢å¤æ¡ä»¶
        function restoreConditionsFromSession() {
            try {
                const saved = sessionStorage.getItem('searchParams');
                if (saved) {
                    const params = JSON.parse(saved);
                    if (params.cond) {
                        const decoded = JSON.parse(decodeURIComponent(atob(params.cond)));
                        if (Array.isArray(decoded) && decoded.length > 0) {
                            decoded.forEach(cond => restoreCondition(cond));
                        }
                    }
                    // æ¢å¤è¡¨å•å…¶ä»–å­—æ®µ
                    if (params.search) document.querySelector('input[name="search"]').value = params.search;
                    if (params.search_field) document.querySelector('select[name="search_field"]').value = params.search_field;
                }
            } catch (e) {
                console.error('Failed to restore conditions:', e);
            }
        }
        
        function collectConditions() {
            const conditions = [];
            const container = document.getElementById('conditionsContainer');
            const items = container.querySelectorAll('.condition-item');
            
            items.forEach(item => {
                const id = item.id.replace('condition-', '');
                const fieldSelect = document.getElementById(`field-${id}`);
                const operatorSelect = document.getElementById(`operator-${id}`);
                const valueInput = document.getElementById(`value-${id}`);
                const roleSelect = document.getElementById(`role-${id}`);
                const paramSelect = document.getElementById(`param-${id}`);
                
                const field = fieldSelect?.value;
                if (!field) return;
                
                const condition = { field };
                
                if (operatorSelect) {
                    let operator = operatorSelect.value;
                    // å¤„ç† has_feature çš„ç‰¹æ®Šæ“ä½œç¬¦
                    if (field === 'has_feature') {
                        condition.negate = (operator === 'not_has');
                        condition.operator = 'exists'; // å†…éƒ¨ä½¿ç”¨çš„æ“ä½œç¬¦
                    } else {
                        condition.operator = operator;
                    }
                }
                
                if (valueInput) {
                    condition.value = valueInput.value;
                }
                
                if (roleSelect) {
                    condition.role = roleSelect.value;
                }
                
                if (paramSelect) {
                    condition.param_name = paramSelect.value;
                }
                
                // éªŒè¯æ¡ä»¶æ˜¯å¦å®Œæ•´
                if (field === 'role' && condition.value) {
                    conditions.push(condition);
                } else if (field === 'role_content' && condition.role && condition.value) {
                    conditions.push(condition);
                } else if (field === 'has_feature' && condition.value) {
                    conditions.push(condition);
                } else if ((field === 'any_content' || field === 'model_contains' || field === 'app_contains' || field === 'error_contains') && condition.value) {
                    conditions.push(condition);
                } else if (field === 'param' && condition.param_name) {
                    if (condition.operator !== 'eq' || condition.value) {
                        conditions.push(condition);
                    }
                }
            });
            
            return conditions;
        }
        
        // è¡¨å•æäº¤æ”¹ä¸ºAJAX POST
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const conditions = collectConditions();
            const conditionsInput = document.getElementById('conditionsInput');
            
            if (conditions.length > 0) {
                conditionsInput.value = btoa(encodeURIComponent(JSON.stringify(conditions)));
            } else {
                conditionsInput.value = '';
            }
            
            // å…³é—­é«˜çº§æœç´¢é¢æ¿
            if (advancedSearchVisible) {
                toggleAdvancedSearch();
            }
            
            // æ”¶é›†è¡¨å•æ•°æ®å¹¶é€šè¿‡AJAXæäº¤
            const formData = new FormData(this);
            formData.set('page', '1'); // æœç´¢æ—¶é‡ç½®ä¸ºç¬¬ä¸€é¡µ
            
            // ä¿å­˜æœç´¢å‚æ•°åˆ°sessionStorageç”¨äºåˆ†é¡µ
            const searchParams = {};
            formData.forEach((value, key) => {
                if (value) searchParams[key] = value;
            });
            sessionStorage.setItem('searchParams', JSON.stringify(searchParams));
            
            // æ‰§è¡Œæœç´¢
            loadRequestsWithParams(searchParams);
        });
        
        // ä½¿ç”¨å‚æ•°åŠ è½½è¯·æ±‚åˆ—è¡¨
        async function loadRequestsWithParams(params = null) {
            setTableLoading();
            const clientStart = performance.now();
            startLoadProgress(estimatedLoadMs);
            
            try {
                let response;
                if (params) {
                    // POSTæœç´¢
                    response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    });
                } else {
                    // GETé»˜è®¤åŠ è½½
                    response = await fetch('/api/requests');
                }
                
                const data = await response.json();
                renderStats(data.stats);
                renderPagination(data.result);
                renderHeaderTotal(data.result.total);
                renderFilters(data.all_models || [], data.all_apps || []);
                renderRequestsIncremental(data.result, data.search_keyword);
                
                updateFilterSummary(data.filter_summary, data.result.total);
                
                const serverMs = data.load_time_ms ? Number(data.load_time_ms) : null;
                const elapsed = performance.now() - clientStart;
                finishLoadProgress('success', serverMs || elapsed);
                if (data.estimated_next_ms) {
                    estimatedLoadMs = Number(data.estimated_next_ms);
                }
            } catch (error) {
                const tbody = document.getElementById('requests-tbody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td class="loading-cell" colspan="7">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
                }
                finishLoadProgress('error');
            }
        }
        
        // é«˜çº§æœç´¢é¢æ¿æ§åˆ¶
        let advancedSearchVisible = false;
        
        function toggleAdvancedSearch() {
            const panel = document.getElementById('advancedSearchPanel');
            const toggle = document.getElementById('advancedToggle');
            const arrow = document.getElementById('advancedArrow');
            
            advancedSearchVisible = !advancedSearchVisible;
            
            if (advancedSearchVisible) {
                panel.classList.add('show');
                toggle.classList.add('active');
                arrow.textContent = 'â–²';
                document.body.style.overflow = 'hidden';
            } else {
                panel.classList.remove('show');
                toggle.classList.remove('active');
                arrow.textContent = 'â–¼';
                document.body.style.overflow = '';
            }
        }
        
        // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
        document.getElementById('advancedSearchPanel').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleAdvancedSearch();
            }
        });
        
        // ESCé”®å…³é—­é«˜çº§æœç´¢é¢æ¿
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && advancedSearchVisible) {
                toggleAdvancedSearch();
            }
        });
        
        function setDateRange(range) {
            const today = new Date();
            const dateFrom = document.querySelector('input[name="date_from"]');
            const dateTo = document.querySelector('input[name="date_to"]');
            
            const formatDate = (d) => d.toISOString().split('T')[0];
            
            dateTo.value = formatDate(today);
            
            if (range === 'today') {
                dateFrom.value = formatDate(today);
            } else if (range === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                dateFrom.value = formatDate(weekAgo);
            } else if (range === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setDate(today.getDate() - 30);
                dateFrom.value = formatDate(monthAgo);
            }
        }
        
        function clearAdvancedFilters() {
            // åªæ¸…é™¤é«˜çº§ç­›é€‰é¡¹ï¼Œä¿ç•™æœç´¢å…³é”®è¯
            document.querySelector('select[name="model_filter"]').value = '';
            document.querySelector('select[name="app_filter"]').value = '';
            document.querySelector('select[name="status_filter"]').value = '';
            document.querySelector('select[name="sort_by"]').value = 'time';
            document.querySelector('select[name="sort_order"]').value = 'desc';
            document.querySelector('input[name="date_from"]').value = '';
            document.querySelector('input[name="date_to"]').value = '';
            document.querySelector('input[name="id_from"]').value = '';
            document.querySelector('input[name="id_to"]').value = '';
            document.querySelector('input[name="min_tokens"]').value = '';
            document.querySelector('input[name="max_tokens"]').value = '';
            document.querySelector('input[name="min_duration"]').value = '';
            document.querySelector('input[name="max_duration"]').value = '';
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é«˜çº§ç­›é€‰æ¡ä»¶ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨å±•å¼€é¢æ¿
        function checkAdvancedFilters() {
            const hasAdvancedFilter = 
                '{{ model_filter }}' || '{{ app_filter }}' || '{{ status_filter }}' ||
                '{{ date_from }}' || '{{ date_to }}' || 
                '{{ min_tokens }}' || '{{ max_tokens }}' ||
                '{{ min_duration }}' || '{{ max_duration }}' ||
                '{{ id_from }}' || '{{ id_to }}' ||
                ('{{ sort_by }}' && '{{ sort_by }}' !== 'time');
            
            if (hasAdvancedFilter) {
                toggleAdvancedSearch();
            }
        }
        
        // æœç´¢ç»“æœé«˜äº®å‡½æ•°
        function highlightText(text, keyword) {
            if (!keyword || !text) return text;
            const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // ç¾åŒ–æ˜¾ç¤ºå‡½æ•°
        function renderRequestDetails(data, contentElement) {
            const requestData = data.request_content;
            const responseData = data.response_content;
            
            let html = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="detail-section">
                        <h4 class="detail-title">åŸºæœ¬ä¿¡æ¯</h4>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 6px;">
                            <div class="param-grid basic-info">
                                <div class="param-item">
                                    <div class="param-label">è¯·æ±‚ID</div>
                                    <div class="param-value">${data.id}</div>
                                </div>
                                <div class="param-item">
                                    <div class="param-label">æ—¶é—´</div>
                                    <div class="param-value">${new Date(data.timestamp).toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}</div>
                                </div>
                                <div class="param-item">
                                    <div class="param-label">æ¨¡å‹</div>
                                    <div class="param-value">${data.model}</div>
                                </div>
                                <div class="param-item">
                                    <div class="param-label">çŠ¶æ€</div>
                                    <div class="param-value">${data.status_code === 200 ? 'âœ… æˆåŠŸ' : data.status_code === 0 ? 'â³ å¤„ç†ä¸­' : 'âŒ é”™è¯¯'}</div>
                                </div>
                                <div class="param-item">
                                    <div class="param-label">è€—æ—¶</div>
                                    <div class="param-value number">${data.duration ? data.duration.toFixed(3) + 's' : 'N/A'}</div>
                                </div>
                                <div class="param-item">
                                    <div class="param-label">åº”ç”¨</div>
                                    <div class="param-value">${data.app_name || '-'}</div>
                                </div>
                            </div>
                            ${data.error_message ? `<div style="background: #fef2f2; color: #dc2626; padding: 0.75rem; border-radius: 4px; margin-top: 1rem;"><strong>é”™è¯¯ä¿¡æ¯:</strong> ${data.error_message}</div>` : ''}
                            ${data.total_tokens > 0 ? `
                            <div class="usage-stats">
                                <div class="usage-item">
                                    <span class="usage-number">${data.input_tokens}</span>
                                    <div class="usage-label">è¾“å…¥Token</div>
                                </div>
                                <div class="usage-item">
                                    <span class="usage-number">${data.output_tokens}</span>
                                    <div class="usage-label">è¾“å‡ºToken</div>
                                </div>
                                <div class="usage-item">
                                    <span class="usage-number">${data.total_tokens}</span>
                                    <div class="usage-label">æ€»Token</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
            `;
            
            // è¯·æ±‚å†…å®¹
            if (requestData) {
                html += `
                    <div class="detail-section">
                        <div class="detail-header">
                            <h4 class="detail-title">è¯·æ±‚å†…å®¹</h4>
                            <button class="view-toggle" onclick="toggleView('request', this)">æŸ¥çœ‹åŸå§‹JSON</button>
                        </div>
                        <div class="content-wrapper">
                            <div id="request-formatted">
                                ${formatRequestContent(requestData)}
                            </div>
                            <div id="request-raw" class="raw-json-wrapper hidden">
                                <button class="copy-json-btn" onclick="copyJsonContent('request')">ğŸ“‹ å¤åˆ¶</button>
                                <pre class="raw-json" id="request-raw-content" style="margin: 0;">${escapeHtml(JSON.stringify(requestData, null, 2))}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // å“åº”å†…å®¹
            if (responseData) {
                html += `
                    <div class="detail-section">
                        <div class="detail-header">
                            <h4 class="detail-title">å“åº”å†…å®¹</h4>
                            <button class="view-toggle" onclick="toggleView('response', this)">æŸ¥çœ‹åŸå§‹JSON</button>
                        </div>
                        <div class="content-wrapper">
                            <div id="response-formatted">
                                ${formatResponseContent(responseData)}
                            </div>
                            <div id="response-raw" class="raw-json-wrapper hidden">
                                <button class="copy-json-btn" onclick="copyJsonContent('response')">ğŸ“‹ å¤åˆ¶</button>
                                <pre class="raw-json" id="response-raw-content" style="margin: 0;">${escapeHtml(JSON.stringify(responseData, null, 2))}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            contentElement.innerHTML = html;
        }
        
        function formatRequestContent(requestData) {
            let html = '';
            
            // æ˜¾ç¤ºè¯·æ±‚å‚æ•°
            if (requestData.model || requestData.temperature !== undefined || requestData.max_tokens !== undefined || requestData.stream !== undefined) {
                html += '<div class="param-grid" style="margin-bottom: 1rem;">';
                
                if (requestData.model) {
                    html += '<div class="param-item"><div class="param-label">æ¨¡å‹</div><div class="param-value">' + requestData.model + '</div></div>';
                }
                
                if (requestData.temperature !== undefined) {
                    html += '<div class="param-item"><div class="param-label">æ¸©åº¦</div><div class="param-value number">' + requestData.temperature + '</div></div>';
                }
                
                if (requestData.max_tokens !== undefined) {
                    html += '<div class="param-item"><div class="param-label">æœ€å¤§Token</div><div class="param-value number">' + requestData.max_tokens + '</div></div>';
                }
                
                if (requestData.stream !== undefined) {
                    html += '<div class="param-item"><div class="param-label">æµå¼</div><div class="param-value boolean">' + (requestData.stream ? 'æ˜¯' : 'å¦') + '</div></div>';
                }
                
                // æ˜¾ç¤ºæ˜¯å¦å¯ç”¨å·¥å…·
                if (requestData.tools && requestData.tools.length > 0) {
                    html += '<div class="param-item"><div class="param-label">å¯ç”¨å·¥å…·</div><div class="param-value"><span class="badge-count">' + requestData.tools.length + ' ä¸ª</span></div></div>';
                }
                
                html += '</div>';
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            if (requestData.messages && Array.isArray(requestData.messages)) {
                html += '<div style="margin-top: 1rem;"><h5 style="margin-bottom: 0.75rem; color: #374151;">å¯¹è¯æ¶ˆæ¯</h5>';
                requestData.messages.forEach((message, index) => {
                    const role = message.role || 'unknown';
                    
                    // å¤„ç†å·¥å…·è°ƒç”¨ç»“æœæ¶ˆæ¯ï¼ˆtoolè§’è‰²ï¼‰
                    if (role === 'tool') {
                        html += '<div class="tool-result-item">' +
                            '<div class="tool-result-name">ğŸ“¥ å·¥å…·è¿”å›ç»“æœ' +
                            (message.tool_call_id ? '<span class="tool-call-id">ID: ' + message.tool_call_id + '</span>' : '') +
                            '</div>' +
                            '<div class="tool-params" style="margin-top: 0.5rem;">' + formatToolContent(message.content) + '</div>' +
                            '</div>';
                        return;
                    }
                    
                    // å¤„ç†å¸¦æœ‰tool_callsçš„assistantæ¶ˆæ¯
                    if (role === 'assistant' && message.tool_calls && message.tool_calls.length > 0) {
                        html += '<div class="message-item ' + role + '">' +
                            '<div class="message-role ' + role + '" onclick="toggleMessage(' + index + ')" id="role-' + index + '">' +
                            getRoleDisplayName(role) +
                            '</div>' +
                            '<div class="message-content" id="content-' + index + '">' +
                            (message.content ? formatMessageContent(message.content) + '<br><br>' : '') +
                            '<div style="margin-top: 0.5rem;"><strong style="color: #d97706;">ğŸ”§ å·¥å…·è°ƒç”¨:</strong></div>';
                        message.tool_calls.forEach((toolCall, tcIndex) => {
                            html += formatToolCall(toolCall, index + '-' + tcIndex);
                        });
                        html += '</div></div>';
                        return;
                    }
                    
                    const content = formatMessageContent(message.content);
                    html += '<div class="message-item ' + role + '">' +
                        '<div class="message-role ' + role + '" onclick="toggleMessage(' + index + ')" id="role-' + index + '">' +
                        getRoleDisplayName(role) +
                        '</div>' +
                        '<div class="message-content" id="content-' + index + '">' + content + '</div>' +
                        '</div>';
                });
                html += '</div>';
            }
            
            // å¦‚æœæœ‰promptå­—æ®µï¼ˆéchatæ¥å£ï¼‰
            if (requestData.prompt) {
                html += '<div style="margin-top: 1rem;">' +
                    '<h5 style="margin-bottom: 0.75rem; color: #374151;">æç¤ºè¯</h5>' +
                    '<div class="message-item">' +
                    '<div class="message-role" onclick="toggleMessage(\'prompt\')" id="role-prompt">ğŸ“ æç¤ºè¯å†…å®¹</div>' +
                    '<div class="message-content" id="content-prompt">' + formatMessageContent(requestData.prompt) + '</div>' +
                    '</div></div>';
            }
            
            // æ˜¾ç¤ºå¯ç”¨å·¥å…·åˆ—è¡¨ï¼ˆæ”¾åœ¨æœ€åï¼‰
            if (requestData.tools && Array.isArray(requestData.tools) && requestData.tools.length > 0) {
                html += '<div class="tools-section" style="margin-top: 1rem;">' +
                    '<div class="collapsible-header collapsed" onclick="toggleCollapsible(\'available-tools\')" id="header-available-tools">' +
                    '<h5 style="color: #7c3aed; margin: 0;">ğŸ”§ å¯ç”¨å·¥å…· <span class="badge-count">' + requestData.tools.length + '</span></h5>' +
                    '</div>' +
                    '<div class="collapsible-content hidden" id="content-available-tools">';
                requestData.tools.forEach((tool, index) => {
                    if (tool.type === 'function' && tool.function) {
                        const func = tool.function;
                        html += '<div class="tool-item">' +
                            '<div class="tool-name">ğŸ› ï¸ ' + (func.name || 'unnamed') + '</div>' +
                            (func.description ? '<div class="tool-description">' + func.description + '</div>' : '') +
                            (func.parameters ? '<div class="collapsible-header collapsed" onclick="event.stopPropagation(); toggleCollapsible(\'tool-params-' + index + '\')" id="header-tool-params-' + index + '" style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">å‚æ•°å®šä¹‰</div>' +
                            '<div class="collapsible-content hidden" id="content-tool-params-' + index + '"><div class="tool-params">' + JSON.stringify(func.parameters, null, 2) + '</div></div>' : '') +
                            '</div>';
                    }
                });
                html += '</div></div>';
            }
            
            return html;
        }
        
        function formatToolCall(toolCall, idPrefix) {
            const func = toolCall.function || {};
            let args = '';
            try {
                if (func.arguments) {
                    const parsed = JSON.parse(func.arguments);
                    args = JSON.stringify(parsed, null, 2);
                }
            } catch (e) {
                args = func.arguments || '';
            }
            
            return '<div class="tool-call-item" style="margin-top: 0.5rem;">' +
                '<div class="tool-call-name">ğŸ“¤ ' + (func.name || 'unknown') +
                (toolCall.id ? '<span class="tool-call-id">ID: ' + toolCall.id + '</span>' : '') +
                '</div>' +
                (args ? '<div class="collapsible-header" onclick="event.stopPropagation(); toggleCollapsible(\'tool-call-args-' + idPrefix + '\')" id="header-tool-call-args-' + idPrefix + '" style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">è°ƒç”¨å‚æ•°</div>' +
                '<div class="collapsible-content" id="content-tool-call-args-' + idPrefix + '"><div class="tool-params">' + args + '</div></div>' : '') +
                '</div>';
        }
        
        function formatToolContent(content) {
            if (typeof content === 'string') {
                try {
                    const parsed = JSON.parse(content);
                    return JSON.stringify(parsed, null, 2);
                } catch (e) {
                    return content;
                }
            }
            return JSON.stringify(content, null, 2);
        }
        
        function toggleCollapsible(id) {
            const header = document.getElementById(`header-${id}`);
            const content = document.getElementById(`content-${id}`);
            
            if (header && content) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    header.classList.remove('collapsed');
                } else {
                    content.classList.add('hidden');
                    header.classList.add('collapsed');
                }
            }
        }
        
        function formatResponseContent(responseData) {
            let html = '';
            
            // æ˜¾ç¤ºå“åº”æ¶ˆæ¯
            if (responseData.choices && Array.isArray(responseData.choices)) {
                html += '<div><h5 style="margin-bottom: 0.75rem; color: #374151;">å“åº”å†…å®¹</h5>';
                responseData.choices.forEach((choice, index) => {
                    const finishReason = choice.finish_reason;
                    const finishReasonBadge = finishReason ? '<span class="finish-reason-badge ' + finishReason + '">' + getFinishReasonDisplay(finishReason) + '</span>' : '';
                    
                    if (choice.message) {
                        const role = choice.message.role || 'assistant';
                        const message = choice.message;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
                        if (message.tool_calls && message.tool_calls.length > 0) {
                            html += '<div class="message-item ' + role + '">' +
                                '<div class="message-role ' + role + '" onclick="toggleMessage(\'response-' + index + '\')" id="role-response-' + index + '">' +
                                getRoleDisplayName(role) + ' <span class="badge-count">åŒ…å«å·¥å…·è°ƒç”¨</span>' + finishReasonBadge + '</div>' +
                                '<div class="message-content" id="content-response-' + index + '">' +
                                (message.content ? formatMessageContent(message.content) + '<br><br>' : '<span style="color: #9ca3af; font-style: italic;">æ¨¡å‹é€‰æ‹©è°ƒç”¨å·¥å…·è€Œéç›´æ¥å›å¤</span><br><br>') +
                                '<div style="margin-top: 0.5rem;"><strong style="color: #d97706;">ğŸ”§ å·¥å…·è°ƒç”¨:</strong></div>';
                            message.tool_calls.forEach((toolCall, tcIndex) => {
                                html += formatToolCall(toolCall, 'response-' + index + '-' + tcIndex);
                            });
                            html += '</div></div>';
                        } else {
                            const content = formatMessageContent(message.content);
                            html += '<div class="message-item ' + role + '">' +
                                '<div class="message-role ' + role + '" onclick="toggleMessage(\'response-' + index + '\')" id="role-response-' + index + '">' +
                                getRoleDisplayName(role) + finishReasonBadge + '</div>' +
                                '<div class="message-content" id="content-response-' + index + '">' + content + '</div></div>';
                        }
                    } else if (choice.text) {
                        html += '<div class="message-item">' +
                            '<div class="message-role" onclick="toggleMessage(\'response-text-' + index + '\')" id="role-response-text-' + index + '">ğŸ“ å“åº”æ–‡æœ¬' + finishReasonBadge + '</div>' +
                            '<div class="message-content" id="content-response-text-' + index + '">' + formatMessageContent(choice.text) + '</div></div>';
                    }
                });
                html += '</div>';
            }
            
            // æ˜¾ç¤ºä½¿ç”¨ç»Ÿè®¡
            if (responseData.usage) {
                html += '<div style="margin-top: 1rem;">' +
                    '<h5 style="margin-bottom: 0.75rem; color: #374151;">ä½¿ç”¨ç»Ÿè®¡</h5>' +
                    '<div class="usage-stats">' +
                    '<div class="usage-item"><span class="usage-number">' + (responseData.usage.prompt_tokens || 0) + '</span><div class="usage-label">è¾“å…¥Token</div></div>' +
                    '<div class="usage-item"><span class="usage-number">' + (responseData.usage.completion_tokens || 0) + '</span><div class="usage-label">è¾“å‡ºToken</div></div>' +
                    '<div class="usage-item"><span class="usage-number">' + (responseData.usage.total_tokens || 0) + '</span><div class="usage-label">æ€»Token</div></div>' +
                    '</div></div>';
            }
            
            return html;
        }
        
        function getFinishReasonDisplay(reason) {
            const reasonMap = {
                'stop': 'âœ… æ­£å¸¸ç»“æŸ',
                'length': 'ğŸ“ é•¿åº¦é™åˆ¶',
                'tool_calls': 'ğŸ”§ å·¥å…·è°ƒç”¨',
                'content_filter': 'ğŸš« å†…å®¹è¿‡æ»¤',
                'function_call': 'ğŸ“ å‡½æ•°è°ƒç”¨',
                'end_turn': 'âœ… ç»“æŸå›åˆ'
            };
            return reasonMap[reason] || reason;
        }
        
        function formatMessageContent(content) {
            if (typeof content === 'string') {
                return content.replace(/\n/g, '<br>').replace(/ {2}/g, '&nbsp;&nbsp;');
            } else if (Array.isArray(content)) {
                // å¤„ç†å¤šæ¨¡æ€å†…å®¹
                return content.map(item => {
                    if (typeof item === 'string') {
                        return item;
                    } else if (item.type === 'text') {
                        return item.text;
                    } else if (item.type === 'image_url') {
                        const imageUrl = item.image_url.url;
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡å ä½ç¬¦
                        if (imageUrl.startsWith('[å›¾ç‰‡å ä½ç¬¦:')) {
                            return '<div style="margin: 0.5rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border: 1px solid #d1d5db;">' +
                                '<div style="font-size: 0.85rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">' +
                                '<span style="font-size: 1.2rem;">ğŸ–¼ï¸</span><span>' + imageUrl + '</span></div></div>';
                        } else if (imageUrl.startsWith('data:image/')) {
                            // å¦‚æœè¿˜æœ‰base64å›¾ç‰‡ï¼ˆæ—§æ•°æ®ï¼‰ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                            return '<div style="margin: 0.5rem 0; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; border: 1px solid #d1d5db;">' +
                                '<div style="font-size: 0.85rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">' +
                                '<span style="font-size: 1.2rem;">ğŸ–¼ï¸</span><span>[å›¾ç‰‡å†…å®¹ - å·²çœç•¥æ˜¾ç¤º]</span></div></div>';
                        } else {
                            return '<div style="margin: 0.5rem 0;">' +
                                '<div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.25rem;">ğŸ“· å›¾ç‰‡é“¾æ¥ï¼š</div>' +
                                '<a href="' + imageUrl + '" target="_blank" style="color: #3b82f6; text-decoration: underline;">' + 
                                (imageUrl.length > 50 ? imageUrl.substring(0, 50) + '...' : imageUrl) + '</a></div>';
                        }
                    }
                    return JSON.stringify(item);
                }).join('<br>');
            }
            return JSON.stringify(content);
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'user': 'ğŸ‘¤ ç”¨æˆ·',
                'assistant': 'ğŸ¤– åŠ©æ‰‹',
                'system': 'âš™ï¸ ç³»ç»Ÿ',
                'function': 'ğŸ”§ å‡½æ•°',
                'tool': 'ğŸ”§ å·¥å…·'
            };
            return roleNames[role] || role;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function copyJsonContent(type) {
            const contentElement = document.getElementById(`${type}-raw-content`);
            if (contentElement) {
                const text = contentElement.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    // æ‰¾åˆ°å¯¹åº”çš„å¤åˆ¶æŒ‰é’®
                    const btn = contentElement.parentElement.querySelector('.copy-json-btn');
                    if (btn) {
                        const originalText = btn.innerHTML;
                        btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('copied');
                        }, 2000);
                    }
                }).catch(err => {
                    alert('å¤åˆ¶å¤±è´¥: ' + err);
                });
            }
        }
        
        function toggleView(type, button) {
            const formatted = document.getElementById(`${type}-formatted`);
            const raw = document.getElementById(`${type}-raw`);
            
            if (formatted.classList.contains('hidden')) {
                formatted.classList.remove('hidden');
                raw.classList.add('hidden');
                button.textContent = 'æŸ¥çœ‹åŸå§‹JSON';
                button.classList.remove('active');
            } else {
                formatted.classList.add('hidden');
                raw.classList.remove('hidden');
                button.textContent = 'æŸ¥çœ‹æ ¼å¼åŒ–';
                button.classList.add('active');
            }
        }

        function toggleMessage(messageIndex) {
            const roleElement = document.getElementById(`role-${messageIndex}`);
            const contentElement = document.getElementById(`content-${messageIndex}`);
            
            if (roleElement && contentElement) {
                if (contentElement.style.display === 'none') {
                    contentElement.style.display = 'block';
                    roleElement.classList.remove('collapsed');
                } else {
                    contentElement.style.display = 'none';
                    roleElement.classList.add('collapsed');
                }
            }
        }
        
        let currentRequestId = null;
        let skipListLoaded = {{ 'true' if skip_list else 'false' }};
        let needsReload = skipListLoaded;
        let listLoaded = false;
        let estimatedLoadMs = {{ estimated_next_ms if estimated_next_ms is not none else 1200 }};
        let progressRAF = null;
        let progressStart = 0;

        function buildQueryParams(pageOverride) {
            const params = new URLSearchParams(window.location.search);
            if (pageOverride) params.set('page', pageOverride);
            params.delete('request');
            return params;
        }

        function renderStats(stats) {
            document.getElementById('stat-total-requests').textContent = stats.total_requests;
            document.getElementById('stat-input-tokens').textContent = stats.total_input_tokens;
            document.getElementById('stat-output-tokens').textContent = stats.total_output_tokens;
            document.getElementById('stat-total-tokens').textContent = stats.total_tokens;
            document.getElementById('stat-avg-duration').textContent = (stats.avg_duration || 0).toFixed(3) + 's';
        }

        function renderHeaderTotal(total) {
            const el = document.getElementById('header-total');
            if (el) el.textContent = total;
        }

        function startLoadProgress(estimateMs) {
            const container = document.getElementById('load-progress');
            const bar = document.getElementById('load-progress-bar');
            const label = document.getElementById('progress-label');
            const timeEl = document.getElementById('progress-time');
            if (!container || !bar || !label || !timeEl) return;
            progressStart = performance.now();
            const est = estimateMs || estimatedLoadMs || 1200;
            container.style.display = 'flex';
            bar.style.width = '0%';
            label.textContent = 'æ­£åœ¨åŠ è½½åˆ—è¡¨';
            timeEl.textContent = `é¢„ä¼° ${Math.round(est)} ms`;
            const animate = () => {
                const elapsed = performance.now() - progressStart;
                const pct = Math.min(90, (elapsed / est) * 90);
                bar.style.width = `${pct}%`;
                progressRAF = requestAnimationFrame(animate);
            };
            progressRAF = requestAnimationFrame(animate);
        }

        function finishLoadProgress(status, actualMs) {
            const container = document.getElementById('load-progress');
            const bar = document.getElementById('load-progress-bar');
            const label = document.getElementById('progress-label');
            const timeEl = document.getElementById('progress-time');
            if (!container || !bar || !label || !timeEl) return;
            if (progressRAF) cancelAnimationFrame(progressRAF);
            const elapsed = performance.now() - progressStart;
            const realMs = actualMs || elapsed;
            bar.style.width = '100%';
            if (status === 'success') {
                label.textContent = 'åŠ è½½å®Œæˆ';
                timeEl.textContent = `è€—æ—¶ ${Math.round(realMs)} ms`;
                setTimeout(() => { container.style.display = 'none'; }, 800);
            } else {
                label.textContent = 'åŠ è½½å¤±è´¥';
                timeEl.textContent = `ç”¨æ—¶ ${Math.round(realMs)} ms`;
                setTimeout(() => { container.style.display = 'none'; }, 1500);
            }
        }

        function renderPagination(result) {
            const container = document.getElementById('pagination-container');
            if (!container) return;
            if (result.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            const currentPage = result.page;
            const parts = [];
            
            if (currentPage > 1) {
                parts.push(`<button class="page-btn" onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`);
            }
            for (let pageNum = 1; pageNum <= result.pages; pageNum++) {
                if (pageNum === currentPage) {
                    parts.push(`<span class="page-btn active">${pageNum}</span>`);
                } else if (pageNum <= 3 || pageNum > result.pages - 3 || (pageNum >= currentPage - 2 && pageNum <= currentPage + 2)) {
                    parts.push(`<button class="page-btn" onclick="goToPage(${pageNum})">${pageNum}</button>`);
                } else if (pageNum === 4 || pageNum === result.pages - 3) {
                    parts.push('<span class="page-btn">...</span>');
                }
            }
            if (currentPage < result.pages) {
                parts.push(`<button class="page-btn" onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`);
            }
            container.innerHTML = parts.join('');
        }
        
        function goToPage(page) {
            // è·å–ä¿å­˜çš„æœç´¢å‚æ•°
            let params = {};
            try {
                params = JSON.parse(sessionStorage.getItem('searchParams') || '{}');
            } catch (e) {}
            params.page = page;
            loadRequestsWithParams(params);
        }

        function statusBadge(code) {
            if (code === 200) return '<span class="status-badge status-success">æˆåŠŸ</span>';
            if (code === 0) return '<span class="status-badge status-pending">å¤„ç†ä¸­</span>';
            return '<span class="status-badge status-error">é”™è¯¯</span>';
        }

        function renderRequestsIncremental(result, searchKeyword) {
            const tbody = document.getElementById('requests-tbody');
            if (!tbody) return;
            if (!result.requests || result.requests.length === 0) {
                tbody.innerHTML = '<tr><td class="loading-cell" colspan="7">æš‚æ— è¯·æ±‚è®°å½•</td></tr>';
                renderPagination({ pages: 0, page: 1 });
                renderHeaderTotal(0);
                listLoaded = true;
                return;
            }

            tbody.innerHTML = '';
            const list = result.requests;
            const batchSize = 10;
            let index = 0;

            const renderBatch = () => {
                const rows = [];
                for (let i = 0; i < batchSize && index < list.length; i++, index++) {
                    const req = list[index];
                    const timestamp = req.timestamp ? req.timestamp.split('T') : ['',''];
                    const date = timestamp[0] || '';
                    const time = (timestamp[1] || '').split('.')[0] || '';
                    const app = req.app_name ? `<span class="app-tag">${req.app_name}</span>` : '<span style="color: #9ca3af; font-style: italic;">-</span>';
                    
                    // æ„å»ºåŒ¹é…ç‰‡æ®µæ˜¾ç¤º
                    let snippetHtml = '';
                    if (searchKeyword && req.match_snippets && req.match_snippets.length > 0) {
                        snippetHtml = '<div class="match-snippets">';
                        req.match_snippets.forEach(snippet => {
                            const sourceNames = {request: 'è¯·æ±‚', response: 'å“åº”', error: 'é”™è¯¯'};
                            const highlightedText = highlightText(escapeHtml(snippet.text), searchKeyword);
                            snippetHtml += `<div class="match-snippet">
                                <span class="source-tag">${sourceNames[snippet.source] || snippet.source}</span>
                                <span class="snippet-text">${highlightedText}</span>
                            </div>`;
                        });
                        snippetHtml += '</div>';
                    }
                    
                    rows.push(`<tr class="request-row" onclick="showRequestDetail(${req.id})">
                        <td><span class="request-id">#${req.id}</span>${snippetHtml}</td>
                        <td><small style="color: #6b7280;">${date}</small><br>${time}</td>
                        <td><span class="model-tag">${searchKeyword ? highlightText(req.model, searchKeyword) : req.model}</span></td>
                        <td>${app}</td>
                        <td>${statusBadge(req.status_code)}</td>
                        <td><div class="token-info"><span class="token-item">è¾“å…¥: ${req.formatted_input_tokens || req.input_tokens || 0}</span><span class="token-item">è¾“å‡º: ${req.formatted_output_tokens || req.output_tokens || 0}</span><span class="token-item">æ€»è®¡: ${req.formatted_total_tokens || req.total_tokens || 0}</span></div></td>
                        <td><span class="duration">${req.formatted_duration || ''}</span></td>
                    </tr>`);
                }
                tbody.insertAdjacentHTML('beforeend', rows.join(''));
                if (index < list.length) {
                    requestAnimationFrame(renderBatch);
                } else {
                    listLoaded = true;
                }
            };

            renderPagination(result);
            renderHeaderTotal(result.total);
            renderBatch();
        }

        function renderFilters(allModels, allApps) {
            const modelSelect = document.querySelector('select[name="model_filter"]');
            const appSelect = document.querySelector('select[name="app_filter"]');
            if (modelSelect && modelSelect.options.length <= 1) {
                allModels.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    if (m === '{{ model_filter }}') opt.selected = true;
                    modelSelect.appendChild(opt);
                });
            }
            if (appSelect && appSelect.options.length <= 1) {
                allApps.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a;
                    opt.textContent = a;
                    if (a === '{{ app_filter }}') opt.selected = true;
                    appSelect.appendChild(opt);
                });
            }
        }

        function setTableLoading() {
            const tbody = document.getElementById('requests-tbody');
            if (tbody) {
                tbody.innerHTML = '<tr><td class="loading-cell" colspan="7">æ­£åœ¨åŠ è½½è¯·æ±‚åˆ—è¡¨<div class="loading-dots"><span></span><span></span><span></span></div></td></tr>';
            }
            const pagination = document.getElementById('pagination-container');
            if (pagination) pagination.innerHTML = '';
        }

        async function loadRequestsList() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æœç´¢å‚æ•°
            let params = null;
            try {
                const saved = sessionStorage.getItem('searchParams');
                if (saved) {
                    params = JSON.parse(saved);
                }
            } catch (e) {}
            
            await loadRequestsWithParams(params);
        }
        
        function updateFilterSummary(summary, total) {
            const summaryBar = document.getElementById('filterSummaryBar');
            const headerText = document.getElementById('filter-summary-text');
            
            if (summary) {
                // å¦‚æœæœ‰æ‘˜è¦ï¼Œæ˜¾ç¤ºæˆ–æ›´æ–°æ‘˜è¦æ 
                if (!summaryBar) {
                    // åˆ›å»ºæ‘˜è¦æ 
                    const tableHeader = document.querySelector('.table-header');
                    const newSummary = document.createElement('div');
                    newSummary.className = 'filter-summary';
                    newSummary.id = 'filterSummaryBar';
                    newSummary.innerHTML = `<span>${summary}</span><button class="clear-btn" onclick="clearAllFilters()">æ¸…é™¤å…¨éƒ¨ç­›é€‰</button>`;
                    tableHeader.insertAdjacentElement('afterend', newSummary);
                } else {
                    summaryBar.querySelector('span').textContent = summary;
                    summaryBar.style.display = 'flex';
                }
                
                if (headerText) {
                    headerText.innerHTML = `ç­›é€‰ç»“æœ (<span id="header-total">${total}</span> æ¡è®°å½•)`;
                }
            } else {
                // æ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œéšè—æ‘˜è¦æ 
                if (summaryBar) {
                    summaryBar.style.display = 'none';
                }
            }
        }
        
        function clearAllFilters() {
            // æ¸…é™¤sessionStorage
            sessionStorage.removeItem('searchParams');
            // æ¸…é™¤è¡¨å•
            document.getElementById('searchForm').reset();
            // æ¸…é™¤æ¡ä»¶å®¹å™¨
            document.getElementById('conditionsContainer').innerHTML = '';
            conditionIdCounter = 0;
            // é‡æ–°åŠ è½½
            loadRequestsWithParams(null);
        }
        
        function copyRequestLink() {
            if (currentRequestId) {
                const url = `${window.location.origin}${window.location.pathname}?request=${currentRequestId}`;
                navigator.clipboard.writeText(url).then(() => {
                    const btn = document.getElementById('copyLinkBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                    btn.style.background = '#dcfce7';
                    btn.style.color = '#166534';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#e0e7ff';
                        btn.style.color = '#3730a3';
                    }, 2000);
                }).catch(err => {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
                });
            }
        }

        async function showRequestDetail(requestId) {
            currentRequestId = requestId;
            const modal = document.getElementById('requestModal');
            const content = document.getElementById('requestDetailContent');
            
            modal.style.display = 'block';
            content.innerHTML = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch(`/api/requests/${requestId}`);
                const data = await response.json();
                
                renderRequestDetails(data, content);
                
            } catch (error) {
                content.innerHTML = `<div style="color: #dc2626;">åŠ è½½è¯·æ±‚è¯¦æƒ…æ—¶å‡ºé”™: ${error.message}</div>`;
            }
        }
        
        function closeRequestDetail() {
            document.getElementById('requestModal').style.display = 'none';
            // å¦‚æœæ˜¯é€šè¿‡?request=å‚æ•°æ‰“å¼€çš„ï¼Œå…³é—­æ—¶åŠ è½½åˆ—è¡¨ä¸”ç§»é™¤å‚æ•°
            const url = new URL(window.location);
            if (url.searchParams.has('request')) {
                url.searchParams.delete('request');
                window.history.replaceState({}, '', url.toString());
                needsReload = true;
            }
            if (needsReload && !listLoaded) {
                needsReload = false;
                loadRequestsList();
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('requestModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRequestDetail();
            }
        });
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRequestDetail();
            }
        });
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é«˜çº§ç­›é€‰æ¡ä»¶ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨å±•å¼€é¢æ¿
            checkAdvancedFilters();
            
            // ä»sessionæ¢å¤æ¡ä»¶
            restoreConditionsFromSession();
            
            const initialRequestId = {{ initial_request_id if initial_request_id else 'null' }};
            if (initialRequestId) {
                // æœ‰requestå‚æ•°æ—¶ï¼šä»…æ‰“å¼€è¯¦æƒ…ï¼Œä¸æ‹‰åˆ—è¡¨ï¼Œå…³é—­åå†åŠ è½½
                showRequestDetail(initialRequestId);
                needsReload = true;
            } else {
                loadRequestsList();
            }
        });
    </script>
</body>
</html>